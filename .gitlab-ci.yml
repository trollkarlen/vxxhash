stages:
  - test
  - build

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  V_HOME: "$CI_PROJECT_DIR/.v"

cache:
  paths:
    - .cargo/
    - .v/
    - vlang/

.test_template: &test_template
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl build-essential
    - curl -L https://github.com/vlang/v/releases/latest/download/v_linux.zip -o v_linux.zip
    - unzip v_linux.zip -d vlang
    - export VLANG_ROOT=$CI_PROJECT_DIR/vlang
    - export PATH=$VLANG_ROOT:$PATH
    - v version

test:ubuntu:
  stage: test
  image: ubuntu:latest
  <<: *test_template
  script:
    - apt-get install -y -qq libxxhash-dev
    - v fmt -verify .
    - v -stats test test/

test:windows:
  stage: test
  image: registry.gitlab.com/gitlab-org/windows-runner:win1909
  tags:
    - windows
  before_script:
    - curl -L https://github.com/msys2/msys2-installer/releases/download/2023-05-26/msys2-x86_64-20230526.exe -o msys2-installer.exe
    - start /wait msys2-installer.exe --accept-licenses --confirm-command --root C:/msys64
    - C:/msys64/usr/bin/bash -lc "pacman -Syu --noconfirm"
    - C:/msys64/usr/bin/bash -lc "pacman -S --noconfirm mingw-w64-x86_64-xxhash mingw-w64-x86_64-gcc mingw-w64-x86_64-make"
    - curl -L https://github.com/vlang/v/releases/latest/download/v_windows.zip -o v_windows.zip
    - unzip v_windows.zip -d vlang
    - export VLANG_ROOT=$CI_PROJECT_DIR/vlang
    - export PATH=$VLANG_ROOT:C:/msys64/mingw64/bin:C:/msys64/usr/bin:$PATH
    - v version
  script:
    # fmt does not work on wondows
    # - v fmt -verify .
    - v -stats test test/

test:alpine:
  stage: test
  image: alpine:latest
  <<: *test_template
  script:
    - apk add --no-cache xxhash-dev
    - v fmt -verify .
    - v -shared vxxhash
    - v examples/hash_example.v
    - v examples/hash_tool.v
    - v examples/streaming_example.v
    - v examples/benchmark.v
    - v -stats test test/

build:check:
  stage: build
  image: ubuntu:latest
  <<: *test_template
  script:
    - apt-get install -y -qq libxxhash-dev
    - v fmt -verify .
    - v -shared vxxhash
    - v examples/hash_example.v
    - v examples/hash_tool.v
    - v examples/streaming_example.v
    - v examples/benchmark.v
    - v -stats test test/
    - cd vxxhash && v -prod .
    - echo "Module compilation successful"
